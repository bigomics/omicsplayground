##
## This file is part of the Omics Playground project.
## Copyright (c) 2018-2023 BigOmics Analytics SA. All rights reserved.
##

contrast_correlation_ui <- function(
    id,
    title,
    info.text,
    caption,
    label = "",
    height,
    width) {
  ns <- shiny::NS(id)

  ctcorrplot.opts <- shiny::tagList(
    ## "Show correlation values in cells."),
    withTooltip(
      shiny::checkboxInput(ns("ctcorrplot_allfc"), "show all contrasts", TRUE),
      "Show all contrasts or just the selected ones."
    ),
    ##       "Fix heatmap layout when changing number of top genes"),
    withTooltip(
      shiny::radioButtons(ns("ctcorrplot_ntop"), "number of top genes",
        c("100", "1000", "all"),
        selected = "1000", inline = TRUE
      ),
      "Number of top genes to compute correlation values."
    )
  )

  PlotModuleUI(
    ns("ctcorrplot"),
    title = title,
    label = "b",
    plotlib = "plotly",
    info.text = info.text,
    caption = caption,
    options = ctcorrplot.opts,
    download.fmt = c("png", "pdf", "csv"),
    height = height,
    width = width
  )
}


contrast_correlation_server <- function(id,
                                        getFoldChangeMatrix,
                                        pgx,
                                        input_comparisons,
                                        watermark = FALSE) {
  moduleServer(id, function(input, output, session) {
    plot_data <- shiny::reactive({
      shiny::req(pgx)

      res <- getFoldChangeMatrix()
      if (is.null(res)) {
        return(NULL)
      }
      if (NCOL(res$fc) < 2) {
        return(NULL)
      }

      fc0 <- res$fc
      qv0 <- res$qv

      ntop <- 2000
      ntop <- input$ctcorrplot_ntop
      if (ntop == "all") ntop <- 999999
      ntop <- as.integer(ntop)

      allfc <- input$ctcorrplot_allfc
      if (!allfc) {
        comp <- input_comparisons()
        if (length(comp) < 2) {
          return(NULL)
        }
        kk <- match(comp, colnames(fc0))
        fc0 <- fc0[, kk, drop = FALSE]
      }

      R.full <- cor(apply(fc0, 2, rank), use = "pairwise")
      jj <- head(order(-rowMeans(fc0**2)), ntop)
      R <- cor(apply(fc0[jj, ], 2, rank), use = "pairwise")
      R <- round(R, digits = 2)
      R
    })

    ctcorrplot.PLOTLY <- function() {
      R <- plot_data()
      col <- playdata::BLUERED(16)
      col <- gplots::colorpanel(64, "royalblue3", "grey90", "indianred3")
      if (min(R, na.rm = TRUE) >= 0) col <- tail(col, 32)
      if (max(R, na.rm = TRUE) <= 0) col <- head(col, 32)

      bluered.pal <- colorRampPalette(colors = c("royalblue3", "grey90", "indianred3"))
      cellnote <- NULL

      plt <- heatmaply::heatmaply(
        R,
        margins = c(250, 200, NA, 0),
        cellnote = cellnote, cellnote_size = 11,
        cellnote_textposition = "middle center",
        colors = bluered.pal,
        limits = c(-1, 1)
      )
      plt
    }

    PlotModuleServer(
      "ctcorrplot",
      func = ctcorrplot.PLOTLY,
      csvFunc = plot_data,
      plotlib = "plotly",
      res = c(80, 85),
      pdf.width = 5, pdf.height = 5,
      add.watermark = watermark
    )
  })
}

# OLD PLOTING FUNCTION
